{% layout 'theme' active_page: "home" %}

<!-- Tag Filters -->
<div class="tag-filters" id="tag-filters">
  <button class="filter-btn active" data-tag="all">All</button>
  {% comment %} Collect all unique tags {% endcomment %}
  {% assign all_tags = "" %}
  {% for post in posts %}
    {% if post.tags %}
      {% assign post_tags = post.tags | split: ", " %}
      {% for tag in post_tags %}
        {% assign trimmed_tag = tag | strip %}
        {% unless all_tags contains trimmed_tag %}
          {% assign all_tags = all_tags | append: trimmed_tag | append: "," %}
        {% endunless %}
      {% endfor %}
    {% endif %}
  {% endfor %}
  {% assign unique_tags = all_tags | split: "," | sort %}
  {% for tag in unique_tags %}
    {% if tag != "" %}
      <button class="filter-btn" data-tag="{{ tag }}">{{ tag }}</button>
    {% endif %}
  {% endfor %}
</div>

<!-- Masonry Blog Grid -->
<div class="blog-grid" id="blog-grid">
  {% for post in posts %}
    {% assign tag_list = post.tags | split: ", " %}
    {% assign tag_classes = "" %}
    {% for tag in tag_list %}
      {% assign trimmed_tag = tag | strip %}
      {% assign tag_classes = tag_classes | append: " tag-" | append: trimmed_tag %}
    {% endfor %}
    <article class="post-card{{ tag_classes }}"
             data-index="{{ forloop.index0 }}"
             data-tags="{{ post.tags }}"
             data-content="{{ post.content | escape }}"
             data-link-url="{{ post.link_url | escape }}"
             data-link-title="{{ post.link_title | escape }}"
             data-link-description="{{ post.link_description | escape }}"
             data-link-image="{{ post.link_image | escape }}">

      <!-- Optional Image -->
      {% if post.image_url %}
        <div class="post-image">
          <img src="{{ post.image_url }}" alt="{{ post.title }}" loading="lazy">
        </div>
      {% endif %}

      <!-- Optional Video -->
      {% if post.video_url %}
        <div class="post-video">
          <video src="{{ post.video_url }}" preload="metadata" playsinline>
            Your browser does not support the video tag.
          </video>
          <button class="video-play-overlay" aria-label="Play video">
            <svg width="64" height="64" viewBox="0 0 24 24" fill="none">
              <circle cx="12" cy="12" r="10" fill="rgba(255, 255, 255, 0.9)" />
              <path d="M10 8l6 4-6 4V8z" fill="currentColor" />
            </svg>
          </button>
        </div>
      {% endif %}

      <!-- Optional Audio -->
      {% if post.audio_url %}
        <div class="post-audio" data-audio-url="{{ post.audio_url }}">
          <canvas class="audio-waveform"></canvas>
          <div class="audio-controls">
            <button class="audio-play-btn" aria-label="Play audio">
              <svg class="play-icon" width="20" height="20" viewBox="0 0 24 24" fill="none">
                <path d="M8 5v14l11-7z" fill="currentColor"/>
              </svg>
              <svg class="pause-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" style="display: none;">
                <path d="M6 4h4v16H6V4zm8 0h4v16h-4V4z" fill="currentColor"/>
              </svg>
            </button>
            <span class="audio-time">0:00</span>
            <span class="audio-duration">0:00</span>
          </div>
        </div>
      {% endif %}

      <!-- Post Content -->
      <div class="post-content">
        <h2 class="post-title">{{ post.title }}</h2>
        {% if post.excerpt %}
          <p class="post-excerpt">{{ post.excerpt }}</p>
        {% endif %}
        <time class="post-date">{{ post.date }}</time>

        <!-- Tags in bottom right -->
        {% if post.tags %}
          <div class="post-tags">
            {% assign tag_list = post.tags | split: ", " %}
            {% for tag in tag_list %}
              <span class="tag">{{ tag }}</span>
            {% endfor %}
          </div>
        {% endif %}
      </div>
    </article>
  {% endfor %}
</div>

<!-- Post Viewer (Gallery-style) -->
<div id="post-viewer" class="post-viewer">
  <div class="viewer-backdrop"></div>

  <button class="viewer-close" onclick="closePostViewer()" aria-label="Close post viewer">
    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
      <line x1="18" y1="6" x2="6" y2="18"></line>
      <line x1="6" y1="6" x2="18" y2="18"></line>
    </svg>
  </button>

  <button class="viewer-nav viewer-prev" onclick="navigatePostViewer(-1)" aria-label="Previous post">
    <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
      <polyline points="15 18 9 12 15 6"></polyline>
    </svg>
  </button>

  <button class="viewer-nav viewer-next" onclick="navigatePostViewer(1)" aria-label="Next post">
    <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
      <polyline points="9 18 15 12 9 6"></polyline>
    </svg>
  </button>

  <div class="viewer-content" id="viewer-content">
    <!-- Content will be injected by JavaScript -->
  </div>

  <div class="viewer-info">
    <div class="viewer-counter">
      <span id="viewer-current">1</span> / <span id="viewer-total">1</span>
    </div>
  </div>
</div>
